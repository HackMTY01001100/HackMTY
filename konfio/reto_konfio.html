<!DOCTYPE html>
<html lang="en">
<head>
        <script src="https://ctrl-alt-tec.github.io/altUI/altUI.js?v=3"></script>
        <link href="https://ctrl-alt-tec.github.io/altUI/altUI.css" rel="stylesheet">

    <link rel="stylesheet" href="https://konfio.mx/css/mvc/design-system.css">
    <link rel="stylesheet" href="reto_konfio.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="MobileOptimized" content="width">
    <title>Konfio</title>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-database.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.css" integrity="sha256-IvM9nJf/b5l2RoebiFno92E5ONttVyaEEsdemDC6iQA=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.js" integrity="sha256-arMsf+3JJK2LoTGqxfnuJPFTU4hAK57MtIPdFpiHXOU=" crossorigin="anonymous"></script>

</head>
<body>
    <h1 class="h1-big main">Tu negocio</h1>

    <div class="card balance">
        <h1 class="h1-big"></h1>

    </div>

    <h2 class="h2">Tus ventas del periodo</h2>
    <h1 class="sales h1"></h1>
    <div class="flex_cont sales_cont">
        <div class="card-shadow sales_count">
            <h3 class="h3">q</h3>
            <span>Numero de clientes en el periodo</span>
        </div>
        <div class="card-shadow sales_max">
            <h3 class="h3">q</h3>
            <span>Tu factura mas grande por venta</span>
            <hr>
            <h4 class="h4">q</h4>
        </div>
        <div class="card-shadow sales_maxClient">
            <h3 class="h3">q</h3>
            <span>Tu factura mas grande por venta</span>
            <hr>
            <h4 class="h4">q</h4>
        </div>
    </div>

    <h2 class="h2">Resumen de gastos</h2>
    <h1 class="expenses h1"></h1>
    <div class="flex_cont expenses_cont">
        <div class="card-shadow expenses_count">
            <h3 class="h3">q</h3>
            <span>Numero de proveedores en el periodo</span>
        </div>
        <div class="card-shadow expenses_max">
                <h3 class="h3">q</h3>
                <span>Tu gasto mas grande por venta</span>
                <hr>
                <h4 class="h4">q</h4>
            </div>
    </div>
    
    <h2 class="h2">Evolucion</h2>
    <canvas class="timeSales"></canvas>
    <canvas class="timeTransactions"></canvas>
    <canvas class="timeCosts"></canvas>
    <canvas class="timeProfit"></canvas>
    
    
    
    <script>

        let userID = new URL(window.location.href).searchParams.get("user");
        document.querySelector('.main').innerHTML = `Mi negocio: ${userID}`;

        let UIMasterDetailView = new UI.MasterDetailView([]);

        document.body.prepend(UIMasterDetailView.dom)

        let section_income = {
            sectionItem: new UI.ListViewItemMaster(null, 'Campañas', '', null).dom, 
            sectionContent: document.createElement('div'), 
            sectionName: 'Campañas' ,
        }
        UIMasterDetailView.addSection(section_income)






        firebase.initializeApp({
            apiKey: "AIzaSyCs9-07jyUUBzLfjLvM_0CaGHv-fseAQ6c",
            authDomain: "hackmty-8c2c2.firebaseapp.com",
            databaseURL: "https://hackmty-8c2c2.firebaseio.com",
            projectId: "hackmty-8c2c2",
            storageBucket: "hackmty-8c2c2.appspot.com",
            messagingSenderId: "339012306355",
            appId: "1:339012306355:web:cfc084202840d28f"
        })


        function convertToNumber(num){
            if(typeof num == "number"){
                return num
            } else if (typeof num == "string") {
                return Number(num.replace(',','.'))
            }
        }
        function getData(userID, callback){
            firebase.database().ref(userID).once('value').then(snapshot=>{
                let sales = [...snapshot.val().filter(i=>i.emisorrfc != userID)]
                let sales_total = sales.reduce(function(a,b){
                    return({total: convertToNumber(a.total) + convertToNumber(b.total)})
                }).total
                let salesMax = [...sales.sort((a,b)=> b.total - a.total )][0]
                let obj_salesClient = {}
                sales.forEach(i=>{
                    if(obj_salesClient[i.emisorname] == undefined){
                        obj_salesClient[i.emisorname] = {
                            emisorname: i.emisorname,
                            total: convertToNumber(i.total),
                            subtotal: convertToNumber(i.subtotal),
                            cost: convertToNumber(i.cost)
                        }
                    } else {
                        obj_salesClient[i.emisorname].total+=convertToNumber(i.total)
                        obj_salesClient[i.emisorname].subtotal+=convertToNumber(i.subtotal)
                        obj_salesClient[i.emisorname].cost+=convertToNumber(i.cost)
                    }
                 })
<<<<<<< HEAD
            
=======

>>>>>>> dcfe1675604f67ff9946a9aad62881c2c9d2b5a1
                let salesMaxClient = obj_salesClient[
                    Object.keys(obj_salesClient).sort((a,b) => obj_salesClient[b].total - obj_salesClient[a].total)[0]
                ]

                document.querySelector('.sales').innerHTML = `$${sales_total.toLocaleString()}`;
                document.querySelector('.sales_count>h3').innerHTML = Object.keys(obj_salesClient).length;
                document.querySelector('.sales_max>h3').innerHTML = `$${salesMax.total.toLocaleString()}`;
                document.querySelector('.sales_max>h4').innerHTML = salesMax.emisorname;
                document.querySelector('.sales_maxClient>h3').innerHTML = `$${salesMaxClient.total.toLocaleString()}`;
                document.querySelector('.sales_maxClient>h4').innerHTML = salesMaxClient.emisorname != '' ? salesMaxClient.emisorname : salesMaxClient.emisorrfc ;

                let expenses = [...snapshot.val().filter(i=>i.emisorrfc==userID)]
                let expenses_total = expenses.reduce(function(a,b){
                    return({total: convertToNumber(a.total) + convertToNumber(b.total)})
                }).total

                let expensesMax = [...expenses.sort((a,b)=> b.cost - a.cost )][0]

                console.log(expenses_total)

                let obj_expensesSuppliers = {}
                expenses.forEach(i=>{
                    if(obj_expensesSuppliers[i.receptorname] == undefined){
                        obj_expensesSuppliers[i.receptorname] = {
                            receptorname: i.receptorname,
                            total: convertToNumber(i.total),
                            subtotal: convertToNumber(i.subtotal),
                            cost: convertToNumber(i.cost)
                        }
                    } else {
                        obj_expensesSuppliers[i.receptorname].total+=convertToNumber(i.total)
                        obj_expensesSuppliers[i.receptorname].subtotal+=convertToNumber(i.subtotal)
                        obj_expensesSuppliers[i.receptorname].cost+=convertToNumber(i.cost)
                    }
                })
                let expensesMaxSupplier = obj_expensesSuppliers[
                    Object.keys(obj_expensesSuppliers).sort((a,b) => obj_expensesSuppliers[b].total - obj_expensesSuppliers[a].total)[0]
                ]

                document.querySelector('.expenses').innerHTML = `$${expenses_total.toLocaleString()}`;
                document.querySelector('.expenses_count>h3').innerHTML = Object.keys(obj_expensesSuppliers).length;

                document.querySelector('.expenses_max>h3').innerHTML = `$${expensesMax.total.toLocaleString()}`;
                document.querySelector('.expenses_max>h4').innerHTML = expensesMax.receptorname != '' ? expensesMax.receptorname : expensesMax.receptorrfc;

                document.querySelector('.balance>h1').innerHTML = Number(sales_total-expenses_total).toLocaleString();


                let timeSales = {}
                snapshot.val().map(i=>{
                    if( timeSales[new Date(i.date).getTime()/1000] == undefined ){
                        timeSales[new Date(i.date).getTime()/1000] = convertToNumber(i.total)
                    } else {
                        timeSales[new Date(i.date).getTime()/1000] += convertToNumber(i.total)
                    }
                })
                new Chart( document.querySelector('.timeSales'), {
                    type: 'line',
                    data: {
                        labels: Object.keys(timeSales).map(i=>new Date(i*1000).toLocaleDateString()),
                        datasets: [{
                            label: 'Ingresos',
                            data: Object.keys(timeSales).map(i=>timeSales[i])
                        }]
                    }
                } )

                let timeTransactions = {}
                snapshot.val().map(i=>{
                    if( timeTransactions[new Date(i.date).getTime()/1000] == undefined ){
                        timeTransactions[new Date(i.date).getTime()/1000] = 1
                    } else {
                        timeTransactions[new Date(i.date).getTime()/1000] ++
                    }
                })
                new Chart( document.querySelector('.timeTransactions'), {
                    type: 'line',
                    data: {
                        labels: Object.keys(timeTransactions).map(i=>new Date(i*1000).toLocaleDateString()),
                        datasets: [{
                            label: 'Transacciones',
                            data: Object.keys(timeTransactions).map(i=>timeTransactions[i])
                        }]
                    }
                } )

                let timeCosts = {}
                snapshot.val().map(i=>{
                    if( timeCosts[new Date(i.date).getTime()/1000] == undefined ){
                        timeCosts[new Date(i.date).getTime()/1000] = 1
                    } else {
                        timeCosts[new Date(i.date).getTime()/1000] ++
                    }
                })
                new Chart( document.querySelector('.timeCosts'), {
                    type: 'line',
                    data: {
                        labels: Object.keys(timeCosts).map(i=>new Date(i*1000).toLocaleDateString()),
                        datasets: [{
                            label: 'Transacciones',
                            data: Object.keys(timeCosts).map(i=>timeCosts[i])
                        }]
                    }
                } )

                //console.log(snapshot.val())
                callback( snapshot.val() )
            })
        }
        getData(userID, function(data){
            console.log(data)
        })
    </script>
</body>
</html>

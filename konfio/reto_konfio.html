<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://konfio.mx/css/mvc/design-system.css">
    <link rel="stylesheet" href="reto_konfio.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="MobileOptimized" content="width">
    <title>Konfio</title>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-database.js"></script>

</head>
<body>
    <h1 class="h1-big py-4 bg-purple-bright">Tu negocio</h1>

    <div class="card balance">
        <h1 class="h1-big"></h1>

    </div>


    <h2 class="h2">Tus ventas del periodo</h2>
    <h1 class="sales h1"></h1>
    <div class="flex_cont sales_cont">
        <div class="card-shadow sales_count">
            <h3 class="h3">q</h3>
            <span>Numero de clientes en el periodo</span>
        </div>
        <div class="card-shadow sales_max">
            <h3 class="h3">q</h3>
            <span>Tu factura mas grande por venta</span>
            <hr>
            <h4 class="h4">q</h4>
        </div>
        <div class="card-shadow sales_maxClient">
            <h3 class="h3">q</h3>
            <span>Tu factura mas grande por venta</span>
            <hr>
            <h4 class="h4">q</h4>
        </div>
    </div>

    <h2 class="h2">Resumen de gastos</h2>
    <h1 class="expenses h1"></h1>
    <div class="flex_cont expenses_cont">
        <div class="card-shadow expenses_count">
            <h3 class="h3">q</h3>
            <span>Numero de proveedores en el periodo</span>
        </div>

        <div class="card-shadow expenses_max">
                <h3 class="h3">q</h3>
                <span>Tu gasto mas grande por venta</span>
                <hr>
                <h4 class="h4">q</h4>
            </div>
    </div>




    <script>

        firebase.initializeApp({
            apiKey: "AIzaSyCs9-07jyUUBzLfjLvM_0CaGHv-fseAQ6c",
            authDomain: "hackmty-8c2c2.firebaseapp.com",
            databaseURL: "https://hackmty-8c2c2.firebaseio.com",
            projectId: "hackmty-8c2c2",
            storageBucket: "hackmty-8c2c2.appspot.com",
            messagingSenderId: "339012306355",
            appId: "1:339012306355:web:cfc084202840d28f"
        })


        function convertToNumber(num){
            if(typeof num == "number"){
                return num
            } else if (typeof num == "string") {
                return Number(num.replace(',','.'))
            }
        }
        let sales;
        function getData(userID, callback){
            firebase.database().ref(userID).once('value').then(snapshot=>{


                sales = [...snapshot.val().filter(i=>i.emisorrfc != userID)]
                let sales_total = sales.reduce(function(a,b){
                    return({total: convertToNumber(a.total) + convertToNumber(b.total)})
                }).total

                let salesMax = [...sales.sort((a,b)=> b.total - a.total )][0]

                let obj_salesClient = {}
                sales.forEach(i=>{
                    if(obj_salesClient[i.emisorname] == undefined){
                        obj_salesClient[i.emisorname] = {
                            emisorname: i.emisorname,
                            total: convertToNumber(i.total),
                            subtotal: convertToNumber(i.subtotal),
                            cost: convertToNumber(i.cost)
                        }
                    } else {
                        obj_salesClient[i.emisorname].total+=convertToNumber(i.total)
                        obj_salesClient[i.emisorname].subtotal+=convertToNumber(i.subtotal)
                        obj_salesClient[i.emisorname].cost+=convertToNumber(i.cost)
                    }
                 })

                let salesMaxClient = obj_salesClient[
                    Object.keys(obj_salesClient).sort((a,b) => obj_salesClient[b].total - obj_salesClient[a].total)[0]
                ]

                document.querySelector('.sales').innerHTML = `$${sales_total.toLocaleString()}`;
                document.querySelector('.sales_count>h3').innerHTML = Object.keys(obj_salesClient).length;
                document.querySelector('.sales_max>h3').innerHTML = `$${salesMax.total.toLocaleString()}`;
                document.querySelector('.sales_max>h4').innerHTML = salesMax.emisorname;
                document.querySelector('.sales_maxClient>h3').innerHTML = `$${salesMaxClient.total.toLocaleString()}`;
                document.querySelector('.sales_maxClient>h4').innerHTML = salesMaxClient.emisorname != '' ? salesMaxClient.emisorname : salesMaxClient.emisorrfc ;

                let expenses = [...snapshot.val().filter(i=>i.emisorrfc==userID)]
                let expenses_total = expenses.reduce(function(a,b){
                    return({total: convertToNumber(a.total) + convertToNumber(b.total)})
                }).total

                let expensesMax = [...expenses.sort((a,b)=> b.cost - a.cost )][0]

                console.log(expenses_total)

                let obj_expensesSuppliers = {}
                expenses.forEach(i=>{
                    if(obj_expensesSuppliers[i.receptorname] == undefined){
                        obj_expensesSuppliers[i.receptorname] = {
                            receptorname: i.receptorname,
                            total: convertToNumber(i.total),
                            subtotal: convertToNumber(i.subtotal),
                            cost: convertToNumber(i.cost)
                        }
                    } else {
                        obj_expensesSuppliers[i.receptorname].total+=convertToNumber(i.total)
                        obj_expensesSuppliers[i.receptorname].subtotal+=convertToNumber(i.subtotal)
                        obj_expensesSuppliers[i.receptorname].cost+=convertToNumber(i.cost)
                    }
                })
                let expensesMaxSupplier = obj_expensesSuppliers[
                    Object.keys(obj_expensesSuppliers).sort((a,b) => obj_expensesSuppliers[b].total - obj_expensesSuppliers[a].total)[0]
                ]

                document.querySelector('.expenses').innerHTML = `$${expenses_total.toLocaleString()}`;
                document.querySelector('.expenses_count>h3').innerHTML = Object.keys(obj_expensesSuppliers).length;

                document.querySelector('.expenses_max>h3').innerHTML = `$${expensesMax.total.toLocaleString()}`;
                document.querySelector('.expenses_max>h4').innerHTML = expensesMax.receptorname != '' ? expensesMax.receptorname : expensesMax.receptorrfc;

                document.querySelector('.balance>h1').innerHTML = Number(sales_total-expenses_total).toLocaleString();


                console.log(expenses)


                //console.log(snapshot.val())
                callback( snapshot.val() )
            })
        }
        getData('TAF100112H1A', function(data){
            console.log(data)
        })
    </script>
</body>
</html>
